<link rel="stylesheet" type="text/css" href="/static/css/base.css" />
<link rel="stylesheet" type="text/css" href="/static/css/sider.css" />

<div class="siderMain">
    <h2 class="side_tle"><i class="myIconfont">&#xe704;</i>快捷菜单</li></h2>
   <ul>
      

   </ul>
    
</div>

<script type="text/javascript" src="/static/js/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="/static/plugins/template/template.js"></script>
<script type="text/javascript" src="/static/plugins/layer-3.1.1/layer.js"></script>
<script type="text/javascript" src="/static/js/tool.js"></script>

<script>
    var navColumns=[
        {
            name:"仪表盘",
            link:"/admin/dashboard",
            chirld:[]
        },
        {
            name:"系统配置",
            chirld:[
                {
                    name:"系统配置",
                    link:"/admin/system"
                },
                {
                    name:"菜单管理",
                    link:"/admin/menu",
                },
                {
                    name:"组织机构管理",
                    link:"/admin/dept",
                },
                {
                    name:"角色管理",
                    link:"/admin/role",
                },
                {
                    name:"用户管理",
                    link:"/admin/user",
                },
                {
                    name:"账户日志",
                    link:"/admin/user/account/log",
                },
                {
                    name:"字典管理",
                    link:"/admin/dict",
                }
            ]
        },
        {
            name:" 业务管理",
            chirld:[
                {
                    name:"生产厂家管理",
                    link:"/admin/drug/manufacturer",
                },
                {
                    name:"药品管理",
                    link:"/admin/drug",
                },
                {
                    name:"报告管理",
                    link:"/admin/report",
                },
                {
                    name:'疾病管理',
                    link:'/admin/disease'
                }
            ],

        },{
            name:" 通知公告",
            link:"/admin/articles",
            chirld:[]
        }
    ]
    $(function(){
        getNav(function(res){
            var currentUrl=getCurrentUrl()
            currentUrl=currentUrl.indexOf("?")>0?currentUrl.split("?")[0]:currentUrl;
            currentUrl=currentUrl.indexOf("/add")>0?currentUrl.split("/add")[0]:currentUrl;
            currentUrl=currentUrl.indexOf("/edit")>0?currentUrl.split("/edit")[0]:currentUrl;
           
            navsGetpermission(navColumns, res, function(newnavColumns){
                var navbarList='';
                navColumns.map(function(obj){
                   
                    if(obj.permission){
                        if(obj.chirld.length<=0 && !checkNull(obj.link)){
                            var link=obj.link;
                            navbarList+= currentUrl==link?'<li class="sider-item nodrop ative">':'<li class="sider-item  nodrop">'
                                navbarList+='<a href="'+link+'" class="nav-link">'
                                navbarList+='<i class="fe fe-folder"></i>'
                                navbarList+=obj.name
                                navbarList+='</a>'
                            navbarList+='</li>'
                        }
                        if(obj.chirld.length>0){
                            navbarList+='<li class="sider-item">'
                                navbarList+='<a href="" class="nav-link toggle_up" data-toggle="dropdowns" onclick="dropdown(event)">'
                                navbarList+='<em> <i class="fe fe-folder"></i>'+obj.name+'</em><span class="fa-chevron-down"><i class="myIconfont drops">&#xe82d;</i></span>'
                                navbarList+='</a>'
                                navbarList+='<dl class="dropdown-menus">'
                            obj.chirld.map(function(objs){
                                if(objs.permission && !checkNull(objs.link)){
                                    navbarList+=currentUrl==objs.link?'<dd class="ative">':'<dd>'
                                    navbarList+='<a class="nav-link" href="'+objs.link+'">'
                                        navbarList+='<i class="fe fe-file"></i>'+objs.name
                                    navbarList+='</a>'
                                    navbarList+='</dd>'
                                }

                            })
                            navbarList+='</dl>'
                            navbarList+='</li>'
                        }
                    }
                })
                $(".siderMain ul").html(navbarList)
                setCurrent()
                $(".slitIcon").on("click",function(event){
                    var widths=$(".sider").width();
                    var margin=parseInt($(".sider").css("margin-left"));
                    if(margin==0){
                        $(".sider").css({"margin-left":"-"+widths+"px"});
                        $(".contentMain .container").css("width","100%")
                        $(".slitIcon").css("left","0px")
                    }else{
                        $(".sider").css({"margin-left":"0px"});
                        $(".contentMain .container").css("width","calc(100% - 220px)")
                        $(".slitIcon").css("left",widths+"px")
                    }

                })
            })
        })
    })
    /***获取导航**/
    function getNav(callBack){
        callBack=callBack?callBack:function(){};
        var newnavColumns=[];
        navColumns.map(function(obj){
            obj.chirld=checkNull(obj.chirld)?[]:obj.chirld;
            if(obj.chirld.length==0 && !checkNull(obj.link)){
                newnavColumns.push(obj.link)
            }
            if(obj.chirld.length>0){
                obj.chirld.map(function(objs){
                    if(!checkNull(objs.link)){
                        newnavColumns.push(objs.link)
                    }
                })
            }
        })
        newnavColumns=newnavColumns.length>0?newnavColumns.join(","):"";
        getpermissionData(newnavColumns, function(res){
            callBack(res)
        })
    }

    /* 为 navColumns导航栏添加权限字段*/
    function navsGetpermission(navColumns, rest, callBack){
        
        var result=rest.result;
        var columnsresult=stringToArry(result);
        //设置权限
        navColumns.map(function(obj){
            if(obj.chirld.length==0 && !checkNull(obj.link)){  //没有下拉
                var link=removeNull(obj.link);
                if(indexof(columnsresult, link)){
                    obj.permission=true;
                }else{
                    obj.permission=false;
                }
            }
            if(obj.chirld.length>0){  //有下拉
                var listArry=[];
                obj.chirld.map(function(listObj){
                    if(!checkNull(listObj.link)){
                        var link=listObj.link;
                        if(indexof(columnsresult, link)){
                            listObj.permission=true;
                            listArry.push(link)
                        }else{
                            listObj.permission=false;
                            
                        }
                    }
                })
                obj.permission=listArry.length>0?true:false;
            }

        })
        
        
        
        callBack(navColumns)

    }

    
    function getCurrentUrl(){
        var url=currentUrl.replace(ipDress,"");
        if(url.indexOf("?")){
            url=url.split("?")[0]
        }
        if(url.lastIndexOf("/")==url.length-1){
            url=url.substring(0,url.lastIndexOf("/"))
        }
        return url
    }
    function dropdown(event){
        var e=window.event|| event
        e.preventDefault();
        var $this=$(e.currentTarget);
        var $parent=$(e.currentTarget).closest(".sider-item");
        
        var toggle_type=$this.hasClass("toggle_up")?"show":$this.hasClass("toggle_down")?"hide":"show";
        if(toggle_type=="show"){
            $parent.find("dl.dropdown-menus").slideUp()
            $this.attr("class","nav-link toggle_down")
        }
        if(toggle_type=="hide"){
            $parent.find("dl.dropdown-menus").slideDown()
            $this.attr("class","nav-link toggle_up")
        }
        
    }

    function setCurrent(){
        var $this=$(".siderMain ul").find(".ative").parents(".sider-item")
            $this.addClass("ative")
            if($this.hasClass("sider-item ")){
                
                


            }
    }
    
</script>